name: Check Progress and Alert Telegram

on:
  # Run on push to track progress
  push:
    branches:
      - main
      - process
  # Run on pull request
  pull_request:
  # Run daily to remind about incomplete exercises
  schedule:
    - cron: '0 14 * * *'  # 9 PM GMT+7 (2 PM UTC) daily
  # Allow manual trigger
  workflow_dispatch:

permissions:
  contents: write

jobs:
  check-progress:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Zig
        uses: mlugg/setup-zig@v2
        with:
          version: 0.15.1

      - name: Check progress
        id: progress
        run: |
          # Read current progress
          if [ -f .progress.txt ]; then
            CURRENT=$(cat .progress.txt)
          else
            CURRENT=0
          fi
          
          # Count total exercises
          TOTAL=$(find exercises -name "*.zig" -type f | wc -l)
          
          # Calculate remaining
          REMAINING=$((TOTAL - CURRENT))
          
          # Calculate percentage
          if [ $TOTAL -gt 0 ]; then
            PERCENTAGE=$((CURRENT * 100 / TOTAL))
          else
            PERCENTAGE=0
          fi
          
          # Find next exercise
          NEXT_NUM=$((CURRENT + 1))
          NEXT_FILE=$(find exercises -name "$(printf '%03d' $NEXT_NUM)_*.zig" | head -1)
          if [ -n "$NEXT_FILE" ]; then
            NEXT_EXERCISE=$(basename "$NEXT_FILE")
          else
            NEXT_EXERCISE="All completed! ðŸŽ‰"
          fi
          
          # Create progress bar (40 characters wide)
          BAR_WIDTH=40
          FILLED=$((PERCENTAGE * BAR_WIDTH / 100))
          EMPTY=$((BAR_WIDTH - FILLED))
          PROGRESS_BAR=""
          for i in $(seq 1 $FILLED); do PROGRESS_BAR="${PROGRESS_BAR}â–ˆ"; done
          for i in $(seq 1 $EMPTY); do PROGRESS_BAR="${PROGRESS_BAR}â–‘"; done
          
          echo "current=$CURRENT" >> $GITHUB_OUTPUT
          echo "total=$TOTAL" >> $GITHUB_OUTPUT
          echo "remaining=$REMAINING" >> $GITHUB_OUTPUT
          echo "percentage=$PERCENTAGE" >> $GITHUB_OUTPUT
          echo "next_exercise=$NEXT_EXERCISE" >> $GITHUB_OUTPUT
          echo "progress_bar=$PROGRESS_BAR" >> $GITHUB_OUTPUT
          
          # Create status message
          STATUS="ðŸ“Š *Ziglings Progress Report*\n\n"
          STATUS="${STATUS}âœ… Completed: ${CURRENT}/${TOTAL} exercises\n"
          STATUS="${STATUS}ðŸ“ˆ Progress: ${PERCENTAGE}%\n"
          STATUS="${STATUS}\`${PROGRESS_BAR}\` ${PERCENTAGE}%\n\n"
          STATUS="${STATUS}â³ Remaining: ${REMAINING} exercises\n"
          
          if [ $REMAINING -gt 0 ]; then
            STATUS="${STATUS}ðŸ“ Next: \`${NEXT_EXERCISE}\`\n\n"
            STATUS="${STATUS}ðŸŽ¯ Keep going! You've got this! ðŸ’ª"
            echo "has_remaining=true" >> $GITHUB_OUTPUT
          else
            STATUS="${STATUS}\nðŸŽ‰ Congratulations! All exercises completed! ðŸŽŠ"
            echo "has_remaining=false" >> $GITHUB_OUTPUT
          fi
          
          # Save status message
          echo "$STATUS" > /tmp/status_message.txt
          
          # Output for display
          echo "Progress: $CURRENT/$TOTAL ($PERCENTAGE%)"
          echo "Remaining: $REMAINING exercises"
          echo "Next exercise: $NEXT_EXERCISE"
          echo "Progress bar: [$PROGRESS_BAR]"

      - name: Send Telegram notification if exercises remain
        if: steps.progress.outputs.has_remaining == 'true'
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          # Read status message
          MESSAGE=$(cat /tmp/status_message.txt)
          
          # Add repository info
          REPO="${{ github.repository }}"
          BRANCH="${{ github.ref_name }}"
          MESSAGE="${MESSAGE}\n\nðŸ“ Repository: ${REPO}\nðŸŒ¿ Branch: ${BRANCH}"
          
          # Add trigger info
          if [ "${{ github.event_name }}" = "schedule" ]; then
            MESSAGE="${MESSAGE}\nâ° Daily reminder"
          elif [ "${{ github.event_name }}" = "push" ]; then
            MESSAGE="${MESSAGE}\nðŸ”” Progress updated"
          fi
          
          # URL encode the message
          MESSAGE=$(echo -e "$MESSAGE" | jq -sRr @uri)
          
          # Send to Telegram
          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -d "chat_id=${TELEGRAM_CHAT_ID}" \
            -d "text=${MESSAGE}" \
            -d "parse_mode=Markdown" \
            -d "disable_web_page_preview=true"

      - name: Send completion notification
        if: steps.progress.outputs.has_remaining == 'false' && github.event_name == 'push'
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          TOTAL="${{ steps.progress.outputs.total }}"
          PROGRESS_BAR="${{ steps.progress.outputs.progress_bar }}"
          
          MESSAGE="ðŸŽ‰ *Congratulations!* ðŸŽ‰\n\n"
          MESSAGE="${MESSAGE}You've completed all Ziglings exercises!\n\n"
          MESSAGE="${MESSAGE}âœ… Completed: ${TOTAL}/${TOTAL} exercises\n"
          MESSAGE="${MESSAGE}\`${PROGRESS_BAR}\` 100%\n\n"
          MESSAGE="${MESSAGE}ðŸ“ Repository: ${{ github.repository }}\n"
          MESSAGE="${MESSAGE}ðŸŒ¿ Branch: ${{ github.ref_name }}\n\n"
          MESSAGE="${MESSAGE}ðŸ† Amazing work! You're now a Zig expert! ðŸ’ª"
          
          MESSAGE=$(echo -e "$MESSAGE" | jq -sRr @uri)
          
          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -d "chat_id=${TELEGRAM_CHAT_ID}" \
            -d "text=${MESSAGE}" \
            -d "parse_mode=Markdown" \
            -d "disable_web_page_preview=true"

      - name: Create progress badge
        run: |
          PERCENTAGE="${{ steps.progress.outputs.percentage }}"
          CURRENT="${{ steps.progress.outputs.current }}"
          TOTAL="${{ steps.progress.outputs.total }}"
          
          # Determine color based on percentage
          if [ $PERCENTAGE -ge 80 ]; then
            COLOR="brightgreen"
          elif [ $PERCENTAGE -ge 50 ]; then
            COLOR="yellow"
          elif [ $PERCENTAGE -ge 25 ]; then
            COLOR="orange"
          else
            COLOR="red"
          fi
          
          echo "Progress: ${CURRENT}/${TOTAL} (${PERCENTAGE}%) - Color: ${COLOR}"

      - name: Update README with current status
        if: github.event_name == 'push'
        run: |
          CURRENT="${{ steps.progress.outputs.current }}"
          TOTAL="${{ steps.progress.outputs.total }}"
          PERCENTAGE="${{ steps.progress.outputs.percentage }}"
          
          # Find next exercise
          NEXT_NUM=$((CURRENT + 1))
          NEXT_FILE=$(find exercises -name "$(printf '%03d' $NEXT_NUM)_*.zig" | head -1)
          if [ -n "$NEXT_FILE" ]; then
            NEXT_EXERCISE=$(basename "$NEXT_FILE")
          else
            NEXT_EXERCISE="None - All completed! ðŸŽ‰"
          fi
          
          # Get current date
          CURRENT_DATE=$(date -u +"%Y-%m-%d %H:%M UTC")
          
          # Check Telegram status
          if [ -n "${{ secrets.TELEGRAM_BOT_TOKEN }}" ]; then
            TELEGRAM_STATUS="âœ… Telegram notifications enabled"
          else
            TELEGRAM_STATUS="â³ Telegram setup needed (optional)"
          fi
          
          # Update the Current Status section in .github/README.md
          if [ -f .github/README.md ]; then
            # Create temporary file with updated status
            awk -v current="$CURRENT" -v total="$TOTAL" -v percentage="$PERCENTAGE" \
                -v nextex="$NEXT_EXERCISE" -v updatedate="$CURRENT_DATE" -v telegram="$TELEGRAM_STATUS" '
              /^## Current Status$/ {
                print $0
                print ""
                print "âœ… Workflow created and ready to use  "
                print "âœ… Local progress checker working  "
                print "âœ… Documentation complete  "
                print telegram "  "
                print ""
                print "**Your current progress:** " current "/" total " exercises (" percentage "%)  "
                print "**Next exercise:** " nextex "  "
                print "**Last updated:** " updatedate
                skip=1
                getline
                while (getline > 0 && !/^## Support$/) { }
                if (/^## Support$/) print $0
                skip=0
                getline
              }
              !skip { print }
            ' .github/README.md > .github/README.md.tmp
            
            mv .github/README.md.tmp .github/README.md
          fi

      - name: Commit and push README updates
        if: github.event_name == 'push'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # Check if there are changes
          if git diff --quiet .github/README.md; then
            echo "No changes to commit"
          else
            git add .github/README.md
            git commit -m "ðŸ¤– Auto-update progress in README [skip ci]"
            git push
          fi
